# labeling_tool
---
!!!!!!!!!!!!!등록 작업시 디바이스id를 20001번 이상으로 해주시가 바랍니다!!!!!!!!!!!!!

https://github.com/woosupRyu/labeling_tool/releases/tag/v1.5 링크에 가셔서 zip파일을 받아 사용하셔야 됩니다.
    
## 필요 설치모듈
---
Linux, Window  
Python3.7, PyQt5(5.14), opencv-python(4.2.0.34), pillow(7.1.2), paho-mqtt(1.5.0), PyMySQL(0.9.3), psutil(5.7.2)   
합성 요구 모듈 : grpcio, grpcio-tools, protobuf  
Mac  
Python3.7, PyQt5(5.14), opencv-contrib-python-headless, pillow(7.1.2), paho-mqtt(1.5.0), PyMySQL(0.9.3), psutil(5.7.2)  
합성 요구 모듈 : grpcio, grpcio-tools, protobuf  

install.py를 실행하시면 자동으로 설치됩니다  

  
## 참고사항  
---
main.py를 실행시킨 후 등록 -> 촬영 -> 검수 -> 라벨링(Bbox,Mask,Mix bbox) -> 합성 -> 라벨링(Aug bbox)순으로 작업을 진행  
  
<img src="https://user-images.githubusercontent.com/46614789/101588106-f648c880-3a28-11eb-82c2-22947e8ec2e1.png"  width="30%" height="30%">
  
main.py를 실행시켰을 때 생성되는 창 -> 최상위 화면  
  
각 단계의 버튼을 클릭하면 해당 작업을 수행할 수 있는 새로운 창이 생성  
  
기능적으로 잘못 된 작업을 돌릴 수 없거나 렉이 걸릴 경우 창을 재시작해도 무관  
  
DB의 데이터를 기준으로 모든 GUI가 구성되어 있기 때문에 작업 완료 후 특별한 액션을 취하지 않고 창을 닫은 후 다음 작업 진행  
  
파란색 버튼들은 클릭할 경우 DB에 접근하는 버튼이기 때문에 비정상적인 상황에서 클릭하면 프로그램이 죽거나 데이터가 잘못 저장될 수 있음  
  
나머지 버튼 및 작업들은 로컬 변수로만 동작하는 버튼  
(**검수작업의 허락, 거절 버튼은 DB와 연동되어 있지만 기능 상, 다른색으로 지정**)  
  
작업 순서에따라 작업하지 않고 DB에서 직접 작업 후, 툴을 사용할 경우 에러가 발생할 수 있으니 왠만하면 툴에서 모든 작업 진행  
    
  
## 등록
---
Environment, Grid, SuperCategory, Category 정보를 등록하는 작업 환경   
**등록 작업에서 데이터를 등록할 경우 반드시 아래의 형식대로 등록** 
  
디바이스  
    Broker_ip : xxx.xxx.xxx.xxx  (x는 0\~9 정수)  
    Device_id : 20001~ (정수)
    층수 : 1\~x (정수)  
    가로 : 1\~x (정수)  
    깊이 : 1\~x (정수)  
    높이 : 1\~x (정수)  
  
그리드  
    x : 1\~x(정수)  
    y : 1\~x(정수)  
    예외 : mix전용 그리드는 x = 0, y = 0 으로 입력  
  
분류  
    분류 : (str)(mix전용 분류 : mix, background전용 분류 : background)  
  
물품등록  
    분류 : 이름 위의 박스에서 물품의 분류를 선택(mix물품은 반드시 분류 : mix를, 물품 background는 반드시 분류 : background를 선택)  
    이름 : (str)**(언더바("_"), 슬래시("/")는 들어갈 경우 뒤의 코드에서 에러 발생)**  
    가로 : 1\~x (정수)  
    깊이 : 1\~x (정수)  
    높이 : 1\~x (정수)  
    촬영 횟수 : 1\~x (정수)  
    이미지 : 찾기 버튼 클릭 후 파일 선택  
    
  <img src="https://user-images.githubusercontent.com/46614789/101588302-6d7e5c80-3a29-11eb-9432-8f6766baa39b.png"  width="60%" height="30%">  
   
   Environment, Grid, Category를 삭제할 경우, 연관된 이후의 모든 데이터가 삭제되므로 왠만하면 삭제 지양
  
## 촬영
---
Environment, Category, Grid를 선택하여 촬영하고 싶은 물품을 선택 하고 촬영하는 환경  
**Mix 데이터는 재촬영시 최소 1장을 찍는 것으로 설정해야 촬영 기능에 접근할 수 있기 때문에 작업을 중단했다 다시 할 경우 Mix를 한장 더 촬영해야 합니다.**  
  
1. 원하는 디바이스, 그리드 선택  
  <img src="https://user-images.githubusercontent.com/46614789/101588793-80ddf780-3a2a-11eb-9a7a-b7536f852a5a.png"  width="60%" height="30%">  
2. 물품 리스트에서 원하는 물품을 선택 후, -> 버튼 클릭 시 중앙의 추가할 물품 리스트로 이동, 추가할 물품에서 특정 물품 선택 후, <- 버튼 클릭 시 좌측의 물품 리스트로 이동 물품추가 버튼 클릭 시, 추가할 물품 리스트의 물품들이 추가된 물품 리스트로 이동, 추가된 물품 리스트에서 특정 물품 선택 후, 삭제(Delete)버튼을 클릭 시 해당 물품 삭제   
  <img src="https://user-images.githubusercontent.com/46614789/101588901-ba166780-3a2a-11eb-9717-cfd3567d0964.png"  width="60%" height="30%">  
  <img src="https://user-images.githubusercontent.com/46614789/101588951-d74b3600-3a2a-11eb-9a59-df1f82e36dbb.png"  width="60%" height="30%">  
3. Mix의 촬영횟수를 Mix 촬영 횟수 아래의 칸에 입력 후, 우측의 등록버튼을 클릭 시, 추가된 물품 리스트에 Mix 추가  
<img src="https://user-images.githubusercontent.com/46614789/101589023-f8ac2200-3a2a-11eb-8db7-15801f65729a.png"  width="60%" height="30%">  
5. 확인버튼 클릭 시 아래의 화면 생성
  <img src="https://user-images.githubusercontent.com/46614789/101589096-1bd6d180-3a2b-11eb-9209-3e18060524a9.png"  width="60%" height="30%">  
6. 촬영  
  촬영버튼을 누르면 냉장고 문이 열리고 물품을 배치 후, 문을 닫으면 사진이 찍힘  
  
  
## 검수
---
촬영된 이미지가 데이터로 쓰일 수 있는지 체크하는 환경   
1. 원하는 카테고리와 그리드 선택, 이전에 검수과정을 진행했었고 그때 거절된 이미지는 붉은색으로 버튼이 생성됨  
  <img src="https://user-images.githubusercontent.com/46614789/86754141-9d40c700-c07b-11ea-8dee-84b433550841.png"  width="60%" height="30%">  
2. 허락(거절)할 오브젝트들 선택(S를 누를 시, 해당 이미지의 체크박스 상태가 바뀌며, F를 누를 시, 거절된 이미지를 제외한 나머지 이미지의 체크박스 상태가 바뀜)   
  <img src="https://user-images.githubusercontent.com/46614789/86754149-9e71f400-c07b-11ea-80d3-14bc1363a9c6.png"  width="60%" height="30%">  
3. 허락(거절)버튼 클릭  
  <img src="https://user-images.githubusercontent.com/46614789/86754155-9f0a8a80-c07b-11ea-8641-bf7a9c5e82a3.png"  width="60%" height="30%">  
4. 허락(거절)된 버튼을 제외한 나머지 버튼 클릭 및 거절  
  <img src="https://user-images.githubusercontent.com/46614789/86754159-9fa32100-c07b-11ea-87f8-7aa2e2286027.png"  width="60%" height="30%">  
5. 거절한 데이터의 경우 촬영 작업 시 버튼이 붉은색으로 표시   
  <img src="https://user-images.githubusercontent.com/46614789/86728974-e850df00-c067-11ea-9bda-67bb444fad18.png"  width="60%" height="30%"> 
  
  한번 허락하거나 거절해서 버튼색이 변한 버튼도 다시 거절, 허락 할 수 있음. 단, 한번 리스트를 갱신하거나 창을 재시작하면 허락된 오브젝트들은 나타나지 않음
**(허락한 데이터는 추후 검수리스트에 보이지 않으니 신중히 선택)** 
  
## 라벨링    
---  
검수된 이미지에 마스크를 그리는 환경  
  <img src="https://user-images.githubusercontent.com/46614789/103265112-29f78c80-49f0-11eb-8cfb-2262d1d84f7a.png"  width="40%" height="40%">  
  Bbox : 촬영된 이미지를 비박싱 하는 창 생성  
  Rotated Bbox : 기울어진 박스를 그릴 수 있는 공간 생성  
  Mask : 촬영된 이미지를 마스킹 하는 창 생성  
  Auto Mask : 마스킹 작업을 보조해주는 기능이 들어간 착업공간 생성  
  Aug Bbox : 합성 이미지를 검수하는 창 생성  
  Mix Bbox : 촬영된 믹스 이미지를 박스치는 창 생성  
  
### Bbox  
---
물체 인식 범위를 지정하는 작업  
  <img src="https://user-images.githubusercontent.com/46614789/101589390-a3bcdb80-3a2b-11eb-9ea9-0605b10b0758.png"  width="60%" height="30%">  
  
  1. 좌측 상단에서 원하는 물품을 선택   
  2. 원하는 오브젝트 선택 후 작업   
  3. **작업 후 저장 버튼 클릭**  
  4. 라벨링을 실수했을 경우 더블클릭 후 작업 시, 자동으로 기존의 라벨은 사라짐  
  5. 약간의 수정만 하면 될 경우, 우측 상단의 수정 버튼을 눌러 수정 환경으로 바꾼 후 수정  
  6. 수정후 **저장**  
    
  ※작업 진행도는 체크박스를 기준으로 카운트됨 저장을 누를 경우 체크박스가 채워지며, 임의로 해제도 가능  
  ※마스크, 비박스는 한 오브젝트에 하나만 존재하므로 이미 비박스가 존재하는 상황에서 더블클릭 시 기존의 것이 사라지고 새로 그려짐  
  ※확대, 축소는 스크롤로 가능하며, 화면이동은 우측 상단의 화면이동 버튼을 클릭한 후, 이미지를 드래그 하여 이동 / 작업 시 다시 마스킹 버튼을 누른 후, 작업  
  ※이미지 리셋 버튼을 누를 경우 이미지 사이즈가 초기 값이 되며, 작업중이던 라벨을 날리고 DB에 저장되어 있는 라벨을 불러옴 
  
### Mask  
---
합성을 위해 물품의 형태를 따는 작업  
  <img src="https://user-images.githubusercontent.com/46614789/101589282-7bcd7800-3a2b-11eb-900e-be025c615da0.png"  width="60%" height="30%">  
  
  1. 좌측 상단에서 원하는 물품을 선택   
  2. 원하는 오브젝트 선택 후 작업   
  3. **작업 후 저장 버튼 클릭**  
  4. 라벨링을 실수했을 경우 더블클릭 후 작업 시, 자동으로 기존의 라벨은 사라짐  
  5. 약간의 수정만 하면 될 경우, 우측 상단의 수정 버튼을 눌러 수정 환경으로 바꾼 후 수정  
  6. 수정후 **저장**  
    
  ※작업 진행도는 체크박스를 기준으로 카운트됨 저장을 누를 경우 체크박스가 채워지며, 임의로 해제도 가능  
  ※마스크, 비박스는 한 오브젝트에 하나만 존재하므로 이미 마스크가 존재하는 상황에서 더블클릭 시 기존의 것이 사라지고 새로 그려짐  
  ※확대, 축소는 스크롤로 가능하며, 화면이동은 우측 상단의 화면이동 버튼을 클릭한 후, 이미지를 드래그 하여 이동 / 작업 시 다시 마스킹 버튼을 누른 후, 작업  
  ※이미지 리셋 버튼을 누를 경우 이미지 사이즈가 초기 값이 되며, 작업중이던 라벨을 날리고 DB에 저장되어 있는 라벨을 불러옴   
  
### Auto Mask  
Mask 작업을 보조해주는 기능이 추가된 작업  
<img src="https://user-images.githubusercontent.com/46614789/103265260-89559c80-49f0-11eb-818a-ff8afbc107c7.png"  width="60%" height="30%">  
기본적인 작업의 순서는 Mask 작업과 동일

  마스킹 작업 중 클릭시 Mask 작업에선 클릭되는 지점에 포인트가 생성되지만, Auto Mask에서는 클릭된 포인트 주변의 가장 가까운 엣지를 찾아 엣지로 포인트를 이동시킴  
  우측에 파라미터 값을 입력할 수 있음  
  범위 : 클릭된 포인트 주변의 몇 픽셀의 엣지를 검출할지 설정  
  엣지 비율 : 검출된 엣지 중 하위 몇 %를 걸러낼지 설정  
  엣지 필터 : 검출된 엣지 중 0~255 범위에서 몇 이상의 엣지만 검출할지 설정  
  
  파라미터 설정 후 적용 버튼을 누르면 이미지가 원본으로 돌아가기 때문에 현재 작업을 날리지 않으려면 저장 후, 적용버튼을 클릭해야함  
  
### Rotated Bbox  
---
물체 인식 범위를 지정하는 작업  
  <img src="https://user-images.githubusercontent.com/46614789/101589592-16c65200-3a2c-11eb-97f7-14c01c6abd0e.png"  width="60%" height="30%">  
  
  1. 비박스를 그림  
  2. 회전 버튼을 누른 후 마우스를 위, 아래로 드래그하여 박스 회전   
  3. 회전 후 수정사항이 있을 경우, 수정 버튼을 누른 뒤 수정  
  4. **작업 후 저장 버튼 클릭**  
    
  ※작업 진행도는 체크박스를 기준으로 카운트됨 저장을 누를 경우 체크박스가 채워지며, 임의로 해제도 가능  
  ※마스크, 비박스는 한 오브젝트에 하나만 존재하므로 이미 비박스가 존재하는 상황에서 더블클릭 시 기존의 것이 사라지고 새로 그려짐  
  ※확대, 축소는 스크롤로 가능하며, 화면이동은 우측 상단의 화면이동 버튼을 클릭한 후, 이미지를 드래그 하여 이동 / 작업 시 다시 마스킹 버튼을 누른 후, 작업  
  ※이미지 리셋 버튼을 누를 경우 이미지 사이즈가 초기 값이 되며, 작업중이던 라벨을 날리고 DB에 저장되어 있는 라벨을 불러옴  
  
### Aug bbox  
---
합성된 이미지와 생성된 비박스의 상태를 체크하는 작업  
<img src="https://user-images.githubusercontent.com/46614789/101879997-89266600-3bd5-11eb-86f9-d478d7735062.png"  width="60%" height="30%">  

  **해당 작업은 이미지 합성을 끝낸 후 사용 가능함**    
      
  1. 오른쪽 상단의 수정 버튼이 활성화 된 상태에서 박스의 꼭지점들을 클릭, 드래그하여 수정할 수 있음  
  2. 박스 제거 버튼을 활성화 시킬 경우 박스가 제거된 순수 이미지만 보여줌  
  3. 현재 작업 메커니즘 상, 박스를 추가 제거할 경우가 존재하지 않음, 그런 상황이 생길 경우, 이미지 버튼 우측의 삭제 버튼으로 이미지 자체를 삭제함
  4. 해당 페이지의 이미지를 전부 검수했을 경우 다음 페이지로 넘어가 같은작업 반복
  
  
### Mix bbox  
---
테스트용 이미지를 비박싱 하는 작업  
<img src="https://user-images.githubusercontent.com/46614789/101880203-dc98b400-3bd5-11eb-9b61-dc711bd1a4de.png"  width="60%" height="30%">  
  1. 좌측 상단의 카테고리 박스에서 원하는 물품들을 선택 시 우측하단에 해당 라벨들 생성   
  2. 원하는 라벨을 선택 후, 비박싱 작업 진행    
  3. 우측 상단의 수정 버튼을 누른 후, 특정박스를 클릭할 경우 해당 박스가 색칠되며 선택됨  
  4. 박스 선택 후, 박스 제거버튼을 누르면 해당 박스가 사라짐  
  5. 작업 완료 후 저장 버튼 클릭  

  
## 합성  
---
라벨링된 데이터를 합성하여 학습 데이터를 생성하는 환경  
  
합성 환경을 설정하기위해 그리드, 배경, 물품을 선택  
(물품별 그리드 기능과 augment 옵션 기능은 현재 합성에선 사용되지 않는다)  

<img src="https://user-images.githubusercontent.com/46614789/101589826-8ccab900-3a2c-11eb-9760-e48c80822429.png"  width="60%" height="30%">  
  
합성하기 클릭      
 

## 모델 학습  
---  
라벨링한 데이터를 이용하여 모델을 학습하는 작업 공간  
### 데이터셋 생성  
---  
라벨링한 데이터로 원하는 데이터 셋을 생성하는 공간  
<img src="https://user-images.githubusercontent.com/46614789/101589901-b4ba1c80-3a2c-11eb-9a0f-1f15dd03357c.png"  width="30%" height="20%">  
원하는 물품들을 체크한 후, 데이터셋 생성 클릭

※현재는 데이터셋 생성 시 선택한 물품으로 이루어진 type2(Mix), type3(Aug) 이미지들을 전부 json으로 출력
### 모델 학습  
---  
데이터 셋과 모델종류, 파라미터등을 설정하여 모델을 학습시키는 공간  
 <img src="https://user-images.githubusercontent.com/46614789/101590084-1bd7d100-3a2d-11eb-96ff-cb046a815d40.png"  width="50%" height="40%">   

## 성능 확인  
---  
<img src="https://user-images.githubusercontent.com/46614789/101590204-55a8d780-3a2d-11eb-8917-1b2cff8f6fdf.png"  width="50%" height="40%">  
원하는 모델을 선택하여 해당 모델의 성능을 확인할 수 있는 공간  
원하는 모델을 선택  
해당 모델의 학습 정도를 선택  
박스를 보여주는 기준이 될 Socre threshold 설정  
카테고리 표시를 체크할 경우 물품의 종류까지 표시되며, 해제할 경우 박스만 보여줌  

모델 on/off를 통해 모델을 키고 끌 수 있음  
모델 off 상태에서는 성능확인 불가능  
지그오픈 : 매대의 문이 열리며 문이 닫힌 후의 상황을 촬영하여 물체인식 결과를 보여줌  
벤치마킹 : 지정 경로에 있는 이미지들에 대해 물체인식 결과를 보여줌   
로그확인 : 해당 모델의 학습 로그를 확인할 수 있음
